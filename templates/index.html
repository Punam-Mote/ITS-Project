<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ITS â€“ Intelligent Tutoring System</title>

    <!-- Google Font: Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: "Roboto", Arial, sans-serif;
            background: #f0f4f8;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        header {
            background: linear-gradient(90deg,#4b6cb7,#182848);
            color:white;
            padding:20px;
            font-size:28px;
            font-weight: 500;
        }
        .container {
            background:white;
            padding:20px;
            margin:20px auto;
            max-width:750px;
            border-radius:14px;
            box-shadow:0 6px 20px rgba(0,0,0,0.15);
            text-align:left;
        }
        h2 {
            font-weight:500;
            color:#182848;
        }
        label {
            font-size: 14px;
            font-weight: 500;
            color:#333;
        }
        input {
            padding:10px;
            margin:5px 0 12px 0;
            width:96%;
            border-radius:6px;
            border:1px solid #ccd3e0;
            font-size:15px;
            box-sizing: border-box;
        }
        button {
            padding:10px 18px;
            margin:5px 5px 10px 0;
            border:none;
            border-radius:20px;
            background:#4b6cb7;
            color:white;
            cursor:pointer;
            font-size:15px;
            font-weight:500;
            transition:0.2s ease;
        }
        button:hover {
            background:#182848;
            transform: scale(1.03);
        }
        button:disabled {
            opacity: 0.5;
            cursor: default;
            transform: none;
        }
        .output-box {
            background:#e6f0ff;
            padding:12px;
            margin-top:10px;
            border-radius:8px;
            white-space: pre-wrap;
            font-size:14px;
        }
        .correct { color: #068a32; font-weight: 700; }
        .incorrect { color: #c62828; font-weight: 700; }

        .info-bar {
            display:flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .info-pill {
            background:#e9efff;
            padding:6px 12px;
            border-radius:20px;
        }

        /* answer cards */
        .answers-grid {
            display:grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap:10px;
            margin-top:10px;
        }
        .answer-card {
            background:#f3f6ff;
            border-radius:8px;
            padding:12px;
            text-align:center;
            cursor:pointer;
            font-size:15px;
            font-weight:500;
            box-shadow:0 2px 6px rgba(0,0,0,0.08);
            transition:0.15s ease;
        }
        .answer-card:hover {
            background:rgb(127, 157, 239);
            transform: translateY(-1px);
        }
        .answer-card.correct {
            background:#c8f7d4;
            border:2px solid #1b8a3a;
        }
        .answer-card.incorrect {
            background:#ffd6d6;
            border:2px solid #c62828;
        }
        .steps-list, .hints-list {
            margin-top:6px;
            padding-left:18px;
        }

        .progress-bar-container {
            width: 100%;
            background: #dde3f0;
            border-radius: 999px;
            margin-top: 10px;
            height: 12px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .why-wrong-title {
            font-weight:700;
        }
        .why-wrong {
            margin-top:6px;
            font-size:13px;
            color:#222;
        }
    </style>
</head>

<body>

<header>ITS â€“ Intelligent Tutoring System</header>

<!-- ========================= CALCULATOR ========================= -->

<div class="container">
    <h2>Compound Interest Calculator</h2>

    <label>Principal (Â£):</label>
    <input id="principal" type="number" placeholder="Principal (Â£)">

    <label>Interest Rate (%):</label>
    <input id="rate" type="number" placeholder="Interest Rate (%)">

    <label>Time (years):</label>
    <input id="time" type="number" placeholder="Time (years)">

    <label>Compounding per year:</label>
    <input id="n" type="number" placeholder="Compounding per year">

    <button onclick="calculate()">Calculate</button>

    <div id="calcResult" class="output-box"></div>
</div>

<!-- ========================= QUIZ ========================= -->

<div class="container">
    <h2>Dynamic Intelligent Quiz (MCQ)</h2>

    <div class="info-bar">
        <div id="difficultyLabel" class="info-pill">Difficulty: 1 (Easy)</div>
        <div id="questionLabel" class="info-pill">Question: 1 / 10</div>
        <div id="scoreLabel" class="info-pill">Score: 0 / 10</div>
        <div id="streakLabel" class="info-pill">Streak: 0</div>
    </div>

    <div class="progress-bar-container">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <div id="quizQuestion" class="output-box"></div>

    <div id="quizOptions" class="answers-grid"></div>

    <button id="nextBtn" onclick="nextQuestion()" disabled>Next Question</button>
    <button id="restartBtn" onclick="restartQuiz()" style="display:none;">Restart Quiz</button>

    <div id="quizFeedback" class="output-box"></div>

    <div class="output-box">
        <div class="section-title">Step-by-Step Calculation</div>
        <ul id="stepsList" class="steps-list"></ul>
    </div>

    <div class="output-box">
        <div class="section-title">Concept Hints</div>
        <ul id="hintsList" class="hints-list"></ul>
    </div>
</div>

<script>
const TOTAL_QUESTIONS = 10;

let quizData = {};
let currentQuestion = 1;
let quizScore = 0;
let answeredCurrent = false;

const misconceptionExplanations = {
    "mis_simple_interest": "You used simple interest (linear growth) instead of compound interest, where interest itself earns interest.",
    "mis_ignore_compounding": "You ignored the compounding frequency n, which controls how often interest is added each year.",
    "mis_one_year_only": "You effectively calculated for just one year even though the time period t is longer.",
};

// ---------- Calculator ----------
function calculate(){
    let payload = {
        principal: document.getElementById("principal").value,
        rate: document.getElementById("rate").value,
        time: document.getElementById("time").value,
        n: document.getElementById("n").value
    };

    fetch("/calculate", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
    })
    .then(r=>r.json())
    .then(res=>{
        if(res.error){
            document.getElementById("calcResult").innerText = res.error;
            return;
        }
        let steps = Object.values(res.steps).map(x=>"â€¢ "+x).join("\n");
        let hints = Object.entries(res.hints).map(([k,v])=>`â€¢ ${k}: ${v}`).join("\n");

        document.getElementById("calcResult").innerText =
            `Final Amount: Â£${res.amount}\n\nSteps:\n${steps}\n\nHints:\n${hints}`;
    });
}

// ---------- Quiz flow ----------
function newQuiz(){
    if(currentQuestion > TOTAL_QUESTIONS){
        showFinalSummary();
        return;
    }

    fetch("/quiz")
    .then(r=>r.json())
    .then(res=>{
        quizData = res;
        answeredCurrent = false;
        document.getElementById("nextBtn").disabled = true;

        document.getElementById("quizQuestion").innerText = res.question;
        document.getElementById("quizFeedback").innerText = "";
        document.getElementById("stepsList").innerHTML = "";
        document.getElementById("hintsList").innerHTML = "";

        buildMCQ(res);
        updateDifficultyBar(res.difficulty);
        updateInfo(res.difficulty, null);  // streak later from check
    });
}

function buildMCQ(res){
    const P=res.principal, rate=res.rate, t=res.time, n=res.n;
    const correct = computeCI(P,rate,t,n);
    const si = Math.round(P*(1+(rate/100)*t)*100)/100;
    const annual = Math.round(P*Math.pow(1+rate/100,t)*100)/100;
    const oneYearOnly = Math.round((P * Math.pow(1 + (rate/100)/n, n)) * 100) / 100;


    let opts=[correct,si,annual,oneYearOnly];
    opts=[...new Set(opts)];
    while(opts.length<4){
        let more = Math.round(correct*(0.85+Math.random()*0.3)*100)/100;
        if(!opts.includes(more)) opts.push(more);
    }
    opts.sort(()=>Math.random()-0.5);

    let html="";
    opts.forEach(v=>{
        html += `<div class="answer-card" data-value="${v}">Â£${v.toFixed(2)}</div>`;
    });

    const optionsDiv = document.getElementById("quizOptions");
    optionsDiv.innerHTML = html;

    document.querySelectorAll(".answer-card").forEach(card=>{
        card.addEventListener("click", ()=> handleAnswerClick(card));
    });
}

function computeCI(P,rate,t,n){
    let r=rate/100;
    return Math.round((P*Math.pow(1+r/n,n*t))*100)/100;
}

function handleAnswerClick(card){
    if(answeredCurrent) return; // ignore extra clicks
    answeredCurrent = true;

    const value = parseFloat(card.dataset.value);
    const payload = {
        principal: quizData.principal,
        rate: quizData.rate,
        time: quizData.time,
        n: quizData.n,
        difficulty: quizData.difficulty,
        user_answer: value
    };

    fetch("/quiz_check",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
    })
    .then(r=>r.json())
    .then(res=>{
        displayQuizResult(res, value);
    });
}

function displayQuizResult(res, chosenValue){
    let fb=document.getElementById("quizFeedback");

    // highlight cards
    const correctAmount = res.correct_amount;
    document.querySelectorAll(".answer-card").forEach(card=>{
        const v = parseFloat(card.dataset.value);
        if(Math.abs(v - correctAmount) < 0.01){
            card.classList.add("correct");
        }
        if(Math.abs(v - chosenValue) < 0.01 && !res.correct){
            card.classList.add("incorrect");
        }
        // disable pointer events
        card.style.pointerEvents = "none";
    });

    if(res.correct){
        fb.innerHTML=`<span class='correct'>Correct! ðŸŽ‰</span> Final amount was Â£${correctAmount.toFixed(2)}`;
        quizScore++;
    } else {
        let msg = `<span class='incorrect'>Incorrect.</span> Correct amount was Â£${correctAmount.toFixed(2)}`;
        if(res.misconception){
            const exp = misconceptionExplanations[res.misconception] || "This answer pattern suggests a misunderstanding about compound interest.";
            msg += `<br><br><span class="why-wrong-title">Detected Misconception:</span> ${res.misconception}`;
            msg += `<div class="why-wrong"><span class="why-wrong-title">Why this is wrong:</span> ${exp}</div>`;
        }
        fb.innerHTML = msg;
    }

    // update info pills
    updateInfo(res.difficulty, res.streak);
    updateDifficultyBar(res.difficulty);

    // steps & hints
    document.getElementById("stepsList").innerHTML =
        Object.values(res.steps).map(x=>`<li>${x}</li>`).join("");

    document.getElementById("hintsList").innerHTML =
        Object.entries(res.hints).map(([k,v])=>`<li>${k}: ${v}</li>`).join("");

    // enable Next button
    document.getElementById("nextBtn").disabled = false;
}

function nextQuestion(){
    if(!answeredCurrent) return; // safety
    currentQuestion++;

    if(currentQuestion > TOTAL_QUESTIONS){
        showFinalSummary();
    } else {
        newQuiz();
    }
}

function showFinalSummary(){
    document.getElementById("quizQuestion").innerText =
        `Quiz completed! Your score is ${quizScore} / ${TOTAL_QUESTIONS}.`;
    document.getElementById("quizOptions").innerHTML = "";
    document.getElementById("nextBtn").style.display = "none";
    document.getElementById("restartBtn").style.display = "inline-block";
    updateInfo(null, null); // just to refresh score & question label
}

function restartQuiz(){
    currentQuestion = 1;
    quizScore = 0;
    answeredCurrent = false;

    document.getElementById("nextBtn").style.display = "inline-block";
    document.getElementById("restartBtn").style.display = "none";

    newQuiz();
}

function updateInfo(diff, streak){
    // difficulty label
    if(diff !== null && diff !== undefined){
        let text=`Difficulty: ${diff}`;
        if(diff===1) text+=" (Easy)";
        else if(diff===2) text+=" (Medium)";
        else if(diff===3) text+=" (Hard)";
        document.getElementById("difficultyLabel").innerText=text;
    }

    // question label
    document.getElementById("questionLabel").innerText =
        `Question: ${Math.min(currentQuestion, TOTAL_QUESTIONS)} / ${TOTAL_QUESTIONS}`;

    // score label (out of 10)
    document.getElementById("scoreLabel").innerText =
        `Score: ${quizScore} / ${TOTAL_QUESTIONS}`;

    // streak from backend learner model
    if(streak !== null && streak !== undefined){
        document.getElementById("streakLabel").innerText = `Streak: ${streak}`;
    }
}

function updateDifficultyBar(diff){
    let bar=document.getElementById("progressBar");
    if(diff===1){
        bar.style.width="33%";
        bar.style.background="#4CAF50";
    } else if(diff===2){
        bar.style.width="66%";
        bar.style.background="#FFA500";
    } else {
        bar.style.width="100%";
        bar.style.background="#E53935";
    }
}

window.onload = ()=> {
    currentQuestion = 1;
    quizScore = 0;
    newQuiz();
};
</script>

</body>
</html>
