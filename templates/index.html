<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ITS – Intelligent Tutoring System</title>
    <style>
        body {
            font-family: Segoe UI, Roboto;
            background: #f0f4f8;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        header {
            background: linear-gradient(90deg,#4b6cb7,#182848);
            color:white;
            padding:20px;
            font-size:28px;
        }
        .container {
            background:white;
            padding:20px;
            margin:20px auto;
            max-width:650px;
            border-radius:10px;
            box-shadow:0 5px 15px rgba(0,0,0,0.2);
            text-align:left;
        }
        input {
            padding:10px;
            margin:5px;
            width:90%;
            border-radius:5px;
            border:1px solid #ccc;
            font-size:16px;
        }
        button {
            padding:10px 15px;
            margin:5px;
            border:none;
            border-radius:5px;
            background:#4b6cb7;
            color:white;
            cursor:pointer;
            font-size:16px;
        }
        button:hover { background:#182848; }
        .output-box {
            background:#e6f0ff;
            padding:10px;
            margin-top:10px;
            border-radius:5px;
            white-space: pre-wrap;
        }
        .correct { color: green; font-weight: bold; }
        .incorrect { color: red; font-weight: bold; }

        .option-btn {
            display:block;
            width:95%;
            text-align:left;
        }

        /* Modal popup */
        .modal {
            display:none;
            position:fixed;
            z-index:999;
            left:0;
            top:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.5);
        }
        .modal-content {
            background:white;
            margin:15% auto;
            padding:20px;
            border-radius:10px;
            max-width:400px;
            text-align:left;
        }
    </style>
</head>
<body>

<header>ITS – Intelligent Tutoring System</header>

<!-- Calculator -->
<div class="container">
    <h2>Compound Interest Calculator</h2>
    <label for="principal">Principal (£):</label>
    <input id="principal" type="number" placeholder="Principal (£)">
    <label for="rate">Interest Rate (%):</label>
    <input id="rate" type="number" placeholder="Interest Rate (%)">
    <label for="time">Time (years):</label>
    <input id="time" type="number" placeholder="Time (years)">
    <label for="n">Compounding per year:</label>
    <input id="n" type="number" placeholder="Compounding per year">
    <button onclick="calculate()">Calculate</button>
    <div id="calcResult" class="output-box"></div>
</div>

<!-- Quiz -->
<div class="container">
    <h2>Dynamic Quiz (MCQ)</h2>
    <div id="quizProgress" class="output-box"></div>
    <div id="difficultyLabel" class="output-box"></div>
    <div id="quizQuestion" class="output-box"></div>

    <div id="optionsContainer"></div>

    <button onclick="checkQuiz()">Check Answer</button>
    <button onclick="newQuiz()">Next Question</button>

    <div id="quizFeedback" class="output-box"></div>
    <div id="quizSteps" class="output-box"></div>
    <div id="quizHints" class="output-box"></div>
    <div id="quizScore" class="output-box">Score: 0</div>
</div>

<!-- Result Modal -->
<div id="resultModal" class="modal">
  <div class="modal-content">
    <h3>Quiz Completed!</h3>
    <p id="summaryText"></p>
    <button onclick="restartQuiz()">Restart Quiz</button>
  </div>
</div>

<script>
let quizData = {};
let score = 0;
let selectedIndex = null;
let questionNumber = 0;
const MAX_QUESTIONS = 10;

// ---------- Calculator ----------
function calculate(){
    let data = {
        principal: document.getElementById("principal").value,
        rate: document.getElementById("rate").value,
        time: document.getElementById("time").value,
        n: document.getElementById("n").value
    };
    fetch("/calculate", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(res => {
        if(res.error){
            document.getElementById("calcResult").innerText = res.error;
            return;
        }
        let stepsText = Object.values(res.steps).join("\n");
        let hintsText = Object.entries(res.hints)
                              .map(([k,v]) => `${k}: ${v}`)
                              .join("\n");
        document.getElementById("calcResult").innerText =
            `Final Amount: £${res.amount}\n\n` +
            `Step-by-Step Calculation:\n${stepsText}\n\n` +
            `Hints:\n${hintsText}`;
    });
}

// ---------- Quiz ----------
function newQuiz(){
    if(questionNumber >= MAX_QUESTIONS){
        showSummary();
        return;
    }

    fetch("/quiz")
    .then(response => response.json())
    .then(res => {
        quizData = res;
        selectedIndex = null;
        questionNumber += 1;

        document.getElementById("quizProgress").innerText =
            `Question ${questionNumber} of ${MAX_QUESTIONS}`;

        document.getElementById("difficultyLabel").innerText =
            "Difficulty: " + res.difficulty;

        document.getElementById("quizQuestion").innerText = res.question;

        document.getElementById("quizFeedback").innerText = "";
        document.getElementById("quizSteps").innerText = "";
        document.getElementById("quizHints").innerText = "";

        // Render MCQ options
        let optionsDiv = document.getElementById("optionsContainer");
        optionsDiv.innerHTML = "";
        res.options.forEach((opt, idx) => {
            let btn = document.createElement("button");
            btn.className = "option-btn";
            btn.innerText = String.fromCharCode(65 + idx) + ") £" + opt;
            btn.onclick = () => selectOption(idx);
            optionsDiv.appendChild(btn);
        });
    });
}

function selectOption(idx){
    selectedIndex = idx;
    let buttons = document.querySelectorAll("#optionsContainer .option-btn");
    buttons.forEach((b, i) => {
        b.style.background = (i === idx) ? "#182848" : "#4b6cb7";
    });
}

function checkQuiz(){
    if(!quizData || quizData.options === undefined){
        document.getElementById("quizFeedback").innerText =
            "Click 'Next Question' to get a quiz first.";
        return;
    }
    if(selectedIndex === null){
        document.getElementById("quizFeedback").innerText =
            "Please select an option.";
        return;
    }

    let correct = (selectedIndex === quizData.correct_index);
    let feedbackBox = document.getElementById("quizFeedback");

    if(correct){
        feedbackBox.innerHTML = "<span class='correct'>Correct!</span>";
        score += 1;
    } else {
        let correctAmount = quizData.options[quizData.correct_index];
        feedbackBox.innerHTML =
            `<span class='incorrect'>Incorrect.</span> ` +
            `Correct Answer: £${correctAmount}`;
    }

    document.getElementById("quizScore").innerText = "Score: " + score;

    // Show detailed steps & hints
    let stepsText = Object.values(quizData.steps).join("\n");
    let hintsText = Object.entries(quizData.hints)
                          .map(([k,v]) => `${k}: ${v}`)
                          .join("\n");
    document.getElementById("quizSteps").innerText =
        "Step-by-Step Calculation:\n" + stepsText;
    document.getElementById("quizHints").innerText =
        "Hints:\n" + hintsText;

    // Update difficulty on server
    fetch("/update_difficulty", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ correct: correct })
    })
    .then(res => res.json())
    .then(res => {
        document.getElementById("difficultyLabel").innerText =
            "Difficulty: " + res.difficulty_label;
    });

    // If this was the last question, show summary
    if(questionNumber >= MAX_QUESTIONS){
        showSummary();
    }
}

function showSummary(){
    let accuracy = (score / MAX_QUESTIONS) * 100;
    let feedback;
    if(accuracy >= 80){
        feedback = "Excellent! You have a strong understanding of compound interest.";
    } else if(accuracy >= 50){
        feedback = "Good effort. Revise medium and hard questions to improve further.";
    } else {
        feedback = "You may need more practice with the basics. Focus on principal, rate, and compounding.";
    }

    let summaryText =
        `Score: ${score} / ${MAX_QUESTIONS}\n` +
        `Accuracy: ${accuracy.toFixed(1)}%\n\n` +
        `Feedback:\n${feedback}`;

    document.getElementById("summaryText").innerText = summaryText;
    document.getElementById("resultModal").style.display = "block";
}

function restartQuiz(){
    score = 0;
    questionNumber = 0;
    document.getElementById("quizScore").innerText = "Score: 0";
    document.getElementById("quizProgress").innerText = "";
    document.getElementById("quizQuestion").innerText = "";
    document.getElementById("quizFeedback").innerText = "";
    document.getElementById("quizSteps").innerText = "";
    document.getElementById("quizHints").innerText = "";
    document.getElementById("optionsContainer").innerHTML = "";
    document.getElementById("resultModal").style.display = "none";
    newQuiz();
}

// Load first quiz automatically
newQuiz();
</script>

</body>
</html>
